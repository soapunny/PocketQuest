// Prisma schema for PocketQuest

generator client {
  provider = "prisma-client-js" //Prisma Client Generator: Read the schema and generate the code for CRUD operations from TS/JS.
}

datasource db {
  provider = "postgresql" //Our DB => postgresql
  url      = env("DATABASE_URL") // not used in Primsa 7.0
}

// =====================
// Enums
// =====================

enum AuthProvider {
  GOOGLE
  KAKAO
}

enum TxType {
  EXPENSE
  INCOME
  SAVING
}

enum CurrencyCode {
  USD
  KRW
}

enum PeriodType {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum LanguageCode {
  en
  ko
}

// =====================
// Models
// =====================

model User {
  id              String  @id @default(cuid()) //primary key/auto-create unique id(cuid)
  email           String? @unique //unique constraint/email is required
  name            String? // nickname
  profileImageUri String? // profile image url
  // IANA timezone identifier (e.g., "America/New_York") used to compute plan period boundaries.
  timeZone        String  @default("America/New_York") //default value: America/New_York

  provider   AuthProvider //auth provider type(GOOGLE, KAKAO, etc.)
  providerId String //auth provider id(google id, kakao id, etc. external id)

  createdAt DateTime @default(now()) @db.Timestamptz(6) //default value: current timestamp
  updatedAt DateTime @updatedAt @db.Timestamptz(6) //auto-update updated at

  transactions Transaction[] //relations: one to many(one user can have many transactions)
  plans        Plan[] //relations: one to many(one user can have many plans)

  activePlanId    String? @unique
  activePlan      Plan?   @relation("ActivePlan", fields: [activePlanId], references: [id], onDelete: SetNull)
}

model Transaction {
  id     String @id @default(cuid()) //auto-create unique id(cuid)
  userId String //user id(foreign key)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type TxType //transaction type(EXPENSE, INCOME, SAVING)

  // Store amounts as minor units (cents / won). Keep it non-negative and rely on `type`.
  amountMinor Int //amount in minor units(cents / won)
  currency    CurrencyCode //currency code(USD, KRW)

  // Optional FX snapshot: 1 USD = fxUsdKrw KRW at the time of the transaction.
  fxUsdKrw Float?

  category   String //category(groceries, gift, Emergency Fund, etc.)
  occurredAt DateTime @db.Timestamptz(6) //occurred at(date and time)

  note String? //note(optional)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@index([userId, occurredAt]) //index for querying transactions by user id and occurred at
  @@index([userId, type]) //index for querying transactions by user id and type
  @@index([userId, category]) //index for querying transactions by user id and category
}

// Plan represents a budget/savings setup for a specific period.
// Multiple plans per user are allowed, but the same period cannot be duplicated.
model Plan {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  activeForUser User? @relation("ActivePlan")

  periodType PeriodType //period type(WEEKLY, BIWEEKLY, MONTHLY)
  // For BIWEEKLY: optional anchor date (e.g., Monday) used to compute biweekly boundaries.
  periodAnchor DateTime? @db.Timestamptz(6) //optional anchor date(e.g., Monday) used to compute biweekly boundaries.
  // Start of the plan period (e.g., first day of month/week)
  periodStart DateTime @db.Timestamptz(6) //start of the plan period(e.g., first day of month/week)
  // Optional end of the period (can be derived, but keeping it helps querying/ranges)
  periodEnd DateTime? @db.Timestamptz(6)

  // Single app currency preference (your UX decision to keep it simple)
  currency CurrencyCode @default(USD)
  language LanguageCode @default(en)
  // 0 = disabled
  totalBudgetLimitMinor Int @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  budgetGoals  BudgetGoal[]
  savingsGoals SavingsGoal[]

  // Prevent duplicate plans for the same user+period
  @@unique([userId, periodType, periodStart])
  // 대시보드 / 히스토리 / 타입별 조회용
  @@index([userId, periodType, periodStart])
  // 단순 시간 조회용 (예: 이번 주, 이번 달)
  @@index([userId, periodStart])
}

model BudgetGoal {
  id     String @id @default(cuid())
  planId String
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Cascade)

  category   String
  limitMinor Int

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@unique([planId, category])
  @@index([planId])
}

model SavingsGoal {
  id     String @id @default(cuid())
  planId String
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Cascade)

  name        String
  targetMinor Int

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@unique([planId, name])
  @@index([planId])
}
